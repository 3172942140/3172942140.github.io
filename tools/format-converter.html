<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è§†é¢‘å›¾ç‰‡è½¬æ¢å·¥å…· - ä¸ªäººåšå®¢</title>
    <link rel="icon" type="image/svg+xml" href="/images/favicon.svg">
    <link rel="icon" type="image/png" href="/images/favicon.png">
    <link rel="stylesheet" href="/css/common.css">
    <style>
        .converter-container {
            max-width: 1200px;
            margin: 6rem auto 2rem;
            padding: 2rem;
        }

        .converter-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .converter-title {
            font-size: 2rem;
            color: #2c3e50;
            margin-bottom: 1rem;
        }

        .converter-description {
            color: #666;
            margin-bottom: 2rem;
        }

        .converter-main {
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        .upload-section {
            text-align: center;
            padding: 3rem;
            border: 2px dashed #ddd;
            border-radius: 8px;
            background-color: #f9f9f9;
            transition: all 0.3s ease;
        }

        .upload-section.drag-over {
            border-color: #3498db;
            background-color: rgba(52, 152, 219, 0.1);
        }

        .upload-icon {
            font-size: 3rem;
            color: #666;
            margin-bottom: 1rem;
        }

        .upload-text {
            color: #666;
            margin-bottom: 1rem;
        }

        .file-input {
            display: none;
        }

        .upload-btn {
            display: inline-block;
            padding: 0.8rem 1.5rem;
            background-color: #3498db;
            color: white;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .upload-btn:hover {
            background-color: #2980b9;
        }

        .settings-section {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .settings-group {
            margin-bottom: 1.5rem;
        }

        .settings-title {
            font-size: 1.2rem;
            color: #2c3e50;
            margin-bottom: 1rem;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .setting-item {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .setting-label {
            color: #666;
            font-size: 0.9rem;
        }

        .setting-input {
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .preview-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .preview-item {
            position: relative;
            background: #f9f9f9;
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
        }

        .preview-image {
            max-width: 100%;
            height: auto;
            border-radius: 4px;
        }

        .preview-info {
            margin-top: 1rem;
            font-size: 0.9rem;
            color: #666;
        }

        .convert-btn {
            display: block;
            width: 100%;
            padding: 1rem;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .convert-btn:hover {
            background-color: #2980b9;
        }

        .error-message {
            color: #e74c3c;
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }

        @media (max-width: 768px) {
            .converter-container {
                padding: 1rem;
                margin-top: 5rem;
            }

            .settings-grid {
                grid-template-columns: 1fr;
            }
        }

        .progress-container {
            margin-top: 1rem;
            padding: 1.5rem;
            border-top: 1px solid #eee;
            background: #f8f9fa;
            border-radius: 8px;
        }
        .progress-details {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.8rem;
        }
        .progress-label {
            font-weight: 500;
            color: #2c3e50;
        }
        .progress-stats {
            display: flex;
            gap: 1rem;
            color: #666;
        }
        .progress-bar {
            width: 100%;
            height: 10px;
            background-color: #e9ecef;
            border-radius: 5px;
            overflow: hidden;
            margin-bottom: 0.8rem;
        }
        .progress-fill {
            width: 0%;
            height: 100%;
            background-color: #3498db;
            transition: width 0.3s ease;
        }
        .progress-info {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            color: #666;
        }
        #timeInfo {
            font-family: monospace;
        }
        .login-notice {
            text-align: center;
            padding: 1rem;
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
            border-radius: 4px;
            margin: 1rem 0;
        }
        
        .login-notice p {
            margin: 0;
            font-size: 0.95rem;
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <a href="/" class="nav-brand">szhAo-blog</a>
            <button class="menu-toggle" aria-label="åˆ‡æ¢èœå•">
                <span></span>
                <span></span>
                <span></span>
            </button>
            <div class="nav-links">
                <a href="/">é¦–é¡µ</a>
                <a href="/tools.html" class="active">å·¥å…·é›†</a>
                <a href="/message.html">ç•™è¨€</a>
                <a href="/about.html">å…³äº</a>
            </div>
            <div class="auth-buttons">
                <button class="btn-outline" id="loginBtn">ç™»å½•</button>
                <button class="btn-primary" id="registerBtn">æ³¨å†Œ</button>
            </div>
        </div>
    </nav>

    <main class="converter-container">
        <header class="converter-header">
            <h1 class="converter-title">è§†é¢‘å›¾ç‰‡è½¬æ¢å·¥å…·</h1>
            <p class="converter-description">æ”¯æŒè§†é¢‘å’Œå›¾ç‰‡æ ¼å¼è½¬æ¢ã€å‹ç¼©å’Œç®€å•ç¼–è¾‘</p>
        </header>

        <div class="converter-main">
            <div class="upload-section" id="dropZone">
                <div class="upload-icon">ğŸ“</div>
                <p class="upload-text">æ‹–æ‹½æ–‡ä»¶åˆ°è¿™é‡Œæˆ–ç‚¹å‡»ä¸Šä¼ </p>
                <input type="file" class="file-input" id="fileInput" accept="image/*,video/*" multiple>
                <label for="fileInput" class="upload-btn">é€‰æ‹©æ–‡ä»¶</label>
            </div>

            <div class="settings-section">
                <div class="settings-group">
                    <h2 class="settings-title">è½¬æ¢è®¾ç½®</h2>
                    <div class="settings-grid">
                        <div class="setting-item">
                            <label class="setting-label">å½“å‰æ ¼å¼</label>
                            <input type="text" class="setting-input" id="currentFormat" readonly>
                        </div>
                        <div class="setting-item">
                            <label class="setting-label">ç›®æ ‡æ ¼å¼</label>
                            <select class="setting-input" id="outputFormat" disabled>
                                <option value="">è¯·å…ˆé€‰æ‹©æ–‡ä»¶</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="login-notice" style="display: none;">
                    <p>è¯·å…ˆç™»å½•åå†ä½¿ç”¨è½¬æ¢åŠŸèƒ½</p>
                </div>
                <div class="progress-container" style="display: none;">
                    <div class="progress-details">
                        <div class="progress-label">è½¬æ¢è¿›åº¦</div>
                        <div class="progress-stats">
                            <span id="progressText">0%</span>
                            <span id="timeInfo">00:00 / 00:00</span>
                        </div>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <div class="progress-info">
                        <span id="fileInfo"></span>
                        <span id="conversionStatus">å‡†å¤‡è½¬æ¢...</span>
                    </div>
                </div>
            </div>

            <div class="preview-section" id="previewSection"></div>

            <button class="convert-btn" id="convertBtn" disabled>å¼€å§‹è½¬æ¢</button>
        </div>
    </main>

    <footer class="footer">
        <div class="footer-content">
            <div class="footer-links">
                <a href="/">é¦–é¡µ</a> | 
                <a href="/tools.html">å·¥å…·é›†</a> |
                <a href="/message.html">ç•™è¨€</a> |
                <a href="/about.html">å…³äº</a> | 
                <span>Â© 2024 ä¸ªäººåšå®¢</span>
            </div>
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const dropZone = document.getElementById('dropZone');
            const fileInput = document.getElementById('fileInput');
            const previewSection = document.getElementById('previewSection');
            const convertBtn = document.getElementById('convertBtn');
            const outputFormat = document.getElementById('outputFormat');
            const quality = document.getElementById('quality');
            const maxSize = document.getElementById('maxSize');
            const loginNotice = document.querySelector('.login-notice');

            // æ£€æŸ¥ç™»å½•çŠ¶æ€
            function checkAuthStatus() {
                const token = localStorage.getItem('token');
                const authButtons = document.querySelector('.auth-buttons');
                const isLoggedIn = !!token;
                
                if (isLoggedIn) {
                    const user = JSON.parse(localStorage.getItem('user'));
                    const isMobile = window.innerWidth <= 768;
                    authButtons.innerHTML = `
                        <span>${isMobile ? user.name : 'æ¬¢è¿ï¼Œ' + user.name}</span>
                        <button class="btn btn-outline" onclick="logout()">é€€å‡º</button>
                    `;
                    // éšè—ç™»å½•æç¤ºï¼Œå¯ç”¨åŠŸèƒ½
                    loginNotice.style.display = 'none';
                    fileInput.disabled = false;
                    dropZone.style.opacity = '1';
                    dropZone.style.pointerEvents = 'auto';
                } else {
                    // æ˜¾ç¤ºç™»å½•æç¤ºï¼Œç¦ç”¨åŠŸèƒ½
                    loginNotice.style.display = 'block';
                    fileInput.disabled = true;
                    convertBtn.disabled = true;
                    dropZone.style.opacity = '0.5';
                    dropZone.style.pointerEvents = 'none';
                }
                return isLoggedIn;
            }

            // æ‹–æ‹½ä¸Šä¼ 
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                if (!checkAuthStatus()) return;
                dropZone.classList.add('drag-over');
            });

            dropZone.addEventListener('dragleave', () => {
                if (!checkAuthStatus()) return;
                dropZone.classList.remove('drag-over');
            });

            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                if (!checkAuthStatus()) {
                    alert('è¯·å…ˆç™»å½•åå†ä½¿ç”¨è½¬æ¢åŠŸèƒ½');
                    return;
                }
                dropZone.classList.remove('drag-over');
                handleFiles(e.dataTransfer.files);
            });

            fileInput.addEventListener('change', () => {
                if (!checkAuthStatus()) {
                    alert('è¯·å…ˆç™»å½•åå†ä½¿ç”¨è½¬æ¢åŠŸèƒ½');
                    return;
                }
                handleFiles(fileInput.files);
            });

            function handleFiles(files) {
                if (files.length === 0) return;

                previewSection.innerHTML = '';
                convertBtn.disabled = false;

                Array.from(files).forEach(file => {
                    const reader = new FileReader();
                    const previewItem = document.createElement('div');
                    previewItem.className = 'preview-item';

                    // è·å–æ–‡ä»¶æ ¼å¼
                    const format = file.type.split('/')[1];
                    document.getElementById('currentFormat').value = format;
                    
                    // æ ¹æ®æ–‡ä»¶ç±»å‹è®¾ç½®å¯ç”¨çš„è½¬æ¢æ ¼å¼
                    const outputFormatSelect = document.getElementById('outputFormat');
                    outputFormatSelect.disabled = false;
                    outputFormatSelect.innerHTML = '<option value="">ä¿æŒåŸæ ¼å¼</option>';
                    
                    if (file.type.startsWith('image/')) {
                        outputFormatSelect.innerHTML += `
                            <option value="jpg">JPG</option>
                            <option value="png">PNG</option>
                            <option value="webp">WebP</option>
                            <option value="gif">GIF</option>
                        `;
                    } else if (file.type.startsWith('video/')) {
                        outputFormatSelect.innerHTML += `
                            <option value="mp4">MP4</option>
                            <option value="webm">WebM</option>
                        `;
                    }

                    reader.onload = (e) => {
                        if (file.type.startsWith('image/')) {
                            const img = document.createElement('img');
                            img.src = e.target.result;
                            img.className = 'preview-image';
                            previewItem.appendChild(img);
                        } else if (file.type.startsWith('video/')) {
                            const video = document.createElement('video');
                            video.src = e.target.result;
                            video.className = 'preview-image';
                            video.controls = true;
                            previewItem.appendChild(video);
                        }

                        const info = document.createElement('div');
                        info.className = 'preview-info';
                        info.textContent = `${file.name} (${formatFileSize(file.size)})`;
                        previewItem.appendChild(info);
                    };

                    reader.readAsDataURL(file);
                    previewSection.appendChild(previewItem);
                });
            }

            function formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }

            // è½¬æ¢åŠŸèƒ½
            convertBtn.addEventListener('click', async () => {
                if (!checkAuthStatus()) {
                    alert('è¯·å…ˆç™»å½•åå†ä½¿ç”¨è½¬æ¢åŠŸèƒ½');
                    return;
                }

                const files = fileInput.files;
                if (!files.length) return;

                const outputFormatValue = outputFormat.value;
                if (!outputFormatValue) {
                    alert('è¯·é€‰æ‹©ç›®æ ‡æ ¼å¼');
                    return;
                }

                convertBtn.disabled = true;
                convertBtn.textContent = 'è½¬æ¢ä¸­...';

                try {
                    for (const file of files) {
                        const reader = new FileReader();
                        reader.onload = async (e) => {
                            let url;
                            try {
                                const blob = new Blob([e.target.result]);
                                url = URL.createObjectURL(blob);

                                if (file.type.startsWith('image/')) {
                                    // å›¾ç‰‡è½¬æ¢
                                    await new Promise((resolve, reject) => {
                                        const img = new Image();
                                        img.onload = async () => {
                                            try {
                                                const canvas = document.createElement('canvas');
                                                canvas.width = img.naturalWidth;
                                                canvas.height = img.naturalHeight;
                                                const ctx = canvas.getContext('2d');
                                                ctx.drawImage(img, 0, 0);

                                                const mimeType = `image/${outputFormatValue}`;
                                                canvas.toBlob(async (blob) => {
                                                    if (!blob) {
                                                        reject(new Error('è½¬æ¢å¤±è´¥ï¼šæ— æ³•åˆ›å»ºæ–‡ä»¶'));
                                                        return;
                                                    }
                                                    const downloadUrl = URL.createObjectURL(blob);
                                                    try {
                                                        const a = document.createElement('a');
                                                        a.href = downloadUrl;
                                                        a.download = `converted.${outputFormatValue}`;
                                                        document.body.appendChild(a);
                                                        await new Promise(resolve => setTimeout(resolve, 100));
                                                        a.click();
                                                        document.body.removeChild(a);
                                                        resolve();
                                                    } catch (error) {
                                                        reject(error);
                                                    } finally {
                                                        URL.revokeObjectURL(downloadUrl);
                                                    }
                                                }, mimeType);
                                            } catch (error) {
                                                reject(error);
                                            }
                                        };
                                        img.onerror = () => reject(new Error('å›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œå¯èƒ½æ˜¯æ ¼å¼ä¸æ”¯æŒæˆ–æ–‡ä»¶æŸå'));
                                        img.src = url;
                                    });
                                } else if (file.type.startsWith('video/')) {
                                    // è§†é¢‘è½¬æ¢
                                    await new Promise((resolve, reject) => {
                                        const video = document.createElement('video');
                                        video.preload = 'metadata';
                                        video.muted = true;
                                        
                                        // æ˜¾ç¤ºè¿›åº¦æ¡
                                        const progressContainer = document.querySelector('.progress-container');
                                        const progressFill = document.getElementById('progressFill');
                                        const progressText = document.getElementById('progressText');
                                        const timeInfo = document.getElementById('timeInfo');
                                        const fileInfo = document.getElementById('fileInfo');
                                        const conversionStatus = document.getElementById('conversionStatus');
                                        
                                        progressContainer.style.display = 'block';
                                        conversionStatus.textContent = 'åŠ è½½è§†é¢‘ä¿¡æ¯...';
                                        
                                        // æ ¼å¼åŒ–æ—¶é—´å‡½æ•°
                                        const formatTime = (seconds) => {
                                            if (!seconds || isNaN(seconds)) return '00:00';
                                            const mins = Math.floor(seconds / 60);
                                            const secs = Math.floor(seconds % 60);
                                            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
                                        };
                                        
                                        // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°å‡½æ•°
                                        const formatFileSize = (bytes) => {
                                            if (bytes === 0) return '0 B';
                                            const k = 1024;
                                            const sizes = ['B', 'KB', 'MB', 'GB'];
                                            const i = Math.floor(Math.log(bytes) / Math.log(k));
                                            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
                                        };

                                        // é”™è¯¯å¤„ç†å‡½æ•°
                                        const handleError = (error) => {
                                            console.error('è§†é¢‘å¤„ç†é”™è¯¯:', error);
                                            progressContainer.style.display = 'none';
                                            reject(error);
                                        };

                                        // è®¾ç½®è§†é¢‘äº‹ä»¶ç›‘å¬
                                        video.onerror = () => handleError(new Error('è§†é¢‘åŠ è½½å¤±è´¥ï¼Œå¯èƒ½æ˜¯æ ¼å¼ä¸æ”¯æŒæˆ–æ–‡ä»¶æŸå'));
                                        video.onabort = () => handleError(new Error('è§†é¢‘åŠ è½½è¢«ä¸­æ–­'));
                                        video.stalled = () => handleError(new Error('è§†é¢‘æ•°æ®è·å–å¤±è´¥'));
                                        
                                        video.onloadedmetadata = async () => {
                                            try {
                                                const isWebM = file.type === 'video/webm';
                                                fileInfo.textContent = `æ–‡ä»¶å¤§å°: ${formatFileSize(file.size)}`;
                                                
                                                if (!isWebM) {
                                                    timeInfo.textContent = `00:00 / ${formatTime(video.duration)}`;
                                                } else {
                                                    timeInfo.textContent = 'å¤„ç†ä¸­...';
                                                }
                                                
                                                conversionStatus.textContent = 'æ­£åœ¨è½¬æ¢...';
                                                
                                                const mediaStream = video.captureStream();
                                                const mediaRecorder = new MediaRecorder(mediaStream, {
                                                    mimeType: `video/${outputFormatValue}`
                                                });

                                                const chunks = [];
                                                let processedSize = 0;
                                                
                                                mediaRecorder.ondataavailable = (e) => {
                                                    if (e.data.size > 0) {
                                                        chunks.push(e.data);
                                                        if (isWebM) {
                                                            processedSize += e.data.size;
                                                            const progress = (processedSize / file.size) * 100;
                                                            progressFill.style.width = `${progress}%`;
                                                            progressText.textContent = `${Math.round(progress)}%`;
                                                            timeInfo.textContent = `å·²å¤„ç†: ${formatFileSize(processedSize)}`;
                                                        }
                                                    }
                                                };

                                                // æ›´æ–°è¿›åº¦ - ä»…å¯¹éWebMæ ¼å¼ä½¿ç”¨æ—¶é—´è¿›åº¦
                                                if (!isWebM) {
                                                    video.ontimeupdate = () => {
                                                        if (video.duration && !isNaN(video.duration)) {
                                                            const progress = (video.currentTime / video.duration) * 100;
                                                            progressFill.style.width = `${progress}%`;
                                                            progressText.textContent = `${Math.round(progress)}%`;
                                                            timeInfo.textContent = `${formatTime(video.currentTime)} / ${formatTime(video.duration)}`;
                                                        }
                                                    };
                                                }

                                                mediaRecorder.onstop = async () => {
                                                    conversionStatus.textContent = 'è½¬æ¢å®Œæˆï¼Œå‡†å¤‡ä¸‹è½½...';
                                                    const blob = new Blob(chunks, { type: `video/${outputFormatValue}` });
                                                    const downloadUrl = URL.createObjectURL(blob);
                                                    try {
                                                        const a = document.createElement('a');
                                                        a.href = downloadUrl;
                                                        a.download = `converted.${outputFormatValue}`;
                                                        document.body.appendChild(a);
                                                        await new Promise(resolve => setTimeout(resolve, 100));
                                                        a.click();
                                                        document.body.removeChild(a);
                                                        
                                                        // é‡ç½®è¿›åº¦æ¡æ˜¾ç¤º
                                                        setTimeout(() => {
                                                            progressContainer.style.display = 'none';
                                                            progressFill.style.width = '0%';
                                                            progressText.textContent = '0%';
                                                            timeInfo.textContent = '00:00 / 00:00';
                                                            fileInfo.textContent = '';
                                                            conversionStatus.textContent = 'å‡†å¤‡è½¬æ¢...';
                                                        }, 2000);
                                                        
                                                        resolve();
                                                    } catch (error) {
                                                        handleError(error);
                                                    } finally {
                                                        URL.revokeObjectURL(downloadUrl);
                                                    }
                                                };

                                                // å¯¹äºWebMæ ¼å¼ï¼Œä½¿ç”¨è¾ƒå°çš„timesliceæ¥è·å–æ›´é¢‘ç¹çš„æ•°æ®æ›´æ–°
                                                video.currentTime = 0;
                                                video.play();
                                                if (isWebM) {
                                                    mediaRecorder.start(100); // æ¯100msè§¦å‘ä¸€æ¬¡ondataavailable
                                                } else {
                                                    mediaRecorder.start();
                                                }

                                                video.onended = () => {
                                                    mediaRecorder.stop();
                                                    video.pause();
                                                };
                                            } catch (error) {
                                                handleError(error);
                                            }
                                        };

                                        video.src = url;
                                    });
                                }
                            } catch (error) {
                                console.error('æ–‡ä»¶å¤„ç†å¤±è´¥:', error);
                                alert(error.message || 'æ–‡ä»¶å¤„ç†å¤±è´¥ï¼Œè¯·é‡è¯•');
                            } finally {
                                if (url) {
                                    URL.revokeObjectURL(url);
                                }
                                convertBtn.disabled = false;
                                convertBtn.textContent = 'å¼€å§‹è½¬æ¢';
                            }
                        };
                        reader.onerror = () => {
                            console.error('æ–‡ä»¶è¯»å–å¤±è´¥');
                            alert('æ–‡ä»¶è¯»å–å¤±è´¥ï¼Œè¯·é‡è¯•');
                            convertBtn.disabled = false;
                            convertBtn.textContent = 'å¼€å§‹è½¬æ¢';
                        };
                        reader.readAsArrayBuffer(file);
                    }
                } catch (error) {
                    console.error('è½¬æ¢è¿‡ç¨‹å‡ºé”™:', error);
                    alert('è½¬æ¢è¿‡ç¨‹å‡ºé”™ï¼Œè¯·é‡è¯•');
                    convertBtn.disabled = false;
                    convertBtn.textContent = 'å¼€å§‹è½¬æ¢';
                }
            });

            // åˆå§‹æ£€æŸ¥ç™»å½•çŠ¶æ€
            checkAuthStatus();
        });

        // é€€å‡ºç™»å½•
        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.reload();
        }
    </script>
</body>
</html>